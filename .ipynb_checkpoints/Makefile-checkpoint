# Compiler and flags
FC=gfortran
FFLAGS=-fcoarray=single

# Directories
SRC_DIR = FKB
BUILD_DIR = build
INCLUDE_DIR = include
TESTS_DIR = tests
SHARE_DIR = ./

# Source files
SOURCES = $(SRC_DIR)/mod_kinds.F90 $(SRC_DIR)/mod_activation.F90 $(SRC_DIR)/mod_layer.F90 $(SRC_DIR)/mod_random.F90 $(SRC_DIR)/mod_dense_layer.F90 $(SRC_DIR)/mod_dropout_layer.F90 $(SRC_DIR)/mod_batchnorm_layer.F90 $(SRC_DIR)/mod_io.F90 $(SRC_DIR)/mod_parallel.F90 $(SRC_DIR)/mod_network.F90 

OBJECTS = $(patsubst $(SRC_DIR)/%.F90,$(BUILD_DIR)/%.o,$(SOURCES))

# Test Sources and executable
TEST_SOURCES = $(wildcard $(TESTS_DIR)/*.F90)
TEST_EXECUTABLES = $(patsubst $(TESTS_DIR)/%.F90,$(TESTS_DIR)/%,$(TEST_SOURCES))

# Build FKB library
$(BUILD_DIR)/libfkb_keras_bridge.so: $(OBJECTS)
	$(FC) $(FCFLAGS) -shared -o $@ $^

# Build rule for each object file
$(BUILD_DIR)/%.o: $(SOURCES)
	$(FC) $(FCFLAGS) -c -o $@ $<
    
# Build test executables
tests: $(TEST_EXECUTABLES)

$(TESTS_DIR)/%: $(TESTS_DIR)/%.F90
	$(FC) $(FCFLAGS) -o $@ $^ -L$(BUILD_DIR) -lfkb_keras_bridge

clean:
	rm -rf $(BUILD_DIR)/*.o libfkb_keras_bridge.so $(TEST_EXECUTABLES)
